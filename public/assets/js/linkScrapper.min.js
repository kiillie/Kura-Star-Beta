jQuery.ajax=(function(_ajax){
	var protocol=location.protocol,hostname=location.hostname,exRegex=RegExp(protocol+'//'+hostname),YQL='http'+(/^https/.test(protocol)?'s':'')+'://query.yahooapis.com/v1/public/yql?callback=?',query='select * from html where url="{URL}" and xpath="*"';
	function isExternal(url){
		return!exRegex.test(url)&&/:\/\//.test(url)
	}
	return function(o){
		var url=o.url;
		if(/get/i.test(o.type)&&!/json/i.test(o.dataType)&&isExternal(url)){
			o.url=YQL;
			o.dataType='json';
			o.data={
				q:query.replace('{URL}',url+(o.data?(/\?/.test(url)?'&':'?')+jQuery.param(o.data):'')),format:'xml'};
				if(!o.success&&o.complete){
					o.success=o.complete;
					delete o.complete
				}o.success=(
					function(_success){
						return function(data){
							if(_success){
								_success.call(this,{responseText:(data.results[0]||'').replace(/<script[^>]+?\/>|<script(.|\s)*?\/script>/gi,'')},'success')
							}
						}
					})(o.success)
				}
							return _ajax.apply(this,arguments)
						}
					})(jQuery.ajax);
							String.prototype.startsWith=function(str){
								return(this.match("^"+str)==str)
							};
							$(document).ready(function(){
								var urlInUse='';
								var tid;
								var setNewTimer=false;
							scrapeURL("");
							abortTimer();
							link_check();
							getUrl("", "");
						 	getUrlData("");
							});
var tid;
var urlInUse='';
var tid;
var setNewTimer=false;
function scrapeURL(urlText){
	if(urlText.indexOf('http://')>=0){
	urlString=getUrl('http://',urlText);
	getUrlData(urlString);
	}
	else if(urlText.indexOf('https://')>=0){
		urlString=getUrl('https://',urlText);
		getUrlData(urlString);
	}
}

function abortTimer(){
	if(null!=tid)clearTimeout(tid)
}

function link_check(){
	urlText=$(".new-addon .new-item .link-url").val();
	if(urlText.indexOf('https') > -1){
		urlText = urlText.replace("https", "http");
	}
	abortTimer();
	tid=setTimeout(function(){
		scrapeURL(urlText);
		$(".new-addon .new-item .link-wrap").hide();
		$(".new-addon .new-item .link-result").show();
	},2000);
}

function getUrl(prefix,urlText){
	var urlString='';
	var startIndex=urlText.indexOf(prefix);
	for(var i=startIndex;i<urlText.length;i++){
		if(urlText[i]==' '||urlText[i]=='\n')break;
		else urlString+=urlText[i]
	}
	return urlString;
}
function getUrlData(urlString){
	if(urlInUse==urlString)return;
	$.ajax({
		url:urlString,
		type:'GET',
		success:function(res){
			urlInUse=urlString;
			var metaName;
			var metaContent;
			var htmlString=res.responseText;
			var $htmlString=$(htmlString);
			var startIndex=htmlString.indexOf('<head>')+6;
			var endIndex=htmlString.indexOf('</head>');
			var headerHTML=htmlString.substring(startIndex,endIndex);
			var $wrapper=$('<div />').html(headerHTML);
			var title='';
			title=$("title",$wrapper).text();
			$('.new-addon .new-item .link-title').val(title);
			$('.new-addon .new-item .link-url-text').text(urlString);
			($wrapper.find("meta")).each(function(index,domElement){
				metaName=$(domElement).attr('name');
				metaProperty=$(domElement).attr('property');
				metaContent=$(domElement).attr('content');
				if(metaName=='description'||metaName=='Description'){
					$('.new-addon .new-item .link-description').text(metaContent)
				}
			});
		}
	})
}